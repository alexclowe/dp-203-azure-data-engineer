#!/usr/bin/env python3
import os, sys, json, requests, yaml, datetime
from pathlib import Path
from dateutil import tz

def arg(name):
    for i,a in enumerate(sys.argv):
        if a == f"--{name}" and i+1 < len(sys.argv): return sys.argv[i+1]
    return None

GITHUB_API = "https://api.github.com"

def gh(method, path, **kwargs):
    headers = kwargs.pop("headers", {})
    headers.update({
        "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
        "Accept": "application/vnd.github+json"
    })
    r = requests.request(method, f"{GITHUB_API}{path}", headers=headers, **kwargs)
    if r.status_code >= 300:
        raise RuntimeError(f"{method} {path} -> {r.status_code}: {r.text}")
    return r.json() if r.text else {}

def search_triage_older_than(repo, days):
    # Search open triage issues created before N days ago
    cutoff = (datetime.datetime.utcnow() - datetime.timedelta(days=days)).date().isoformat()
    q = f"repo:{repo} is:issue is:open label:triage created:<{cutoff}"
    res = gh("GET", "/search/issues", params={"q": q, "per_page": 100})
    return res.get("items", [])

def list_comments(repo, issue_number):
    out = []
    page = 1
    while True:
        res = gh("GET", f"/repos/{repo}/issues/{issue_number}/comments", params={"per_page":100, "page":page})
        if not res: break
        out.extend(res)
        if len(res) < 100: break
        page += 1
    return out

def comment(repo, issue_number, body):
    gh("POST", f"/repos/{repo}/issues/{issue_number}/comments", json={"body": body})

def main():
    repo = arg("repo")
    cfg_path = Path(arg("config") or ".github/agent.yml")
    days = int(arg("days") or "7")
    cfg = yaml.safe_load(cfg_path.read_text(encoding="utf-8"))
    cds = [a.lstrip("@") for a in cfg.get("content_developers", [])]
    mgrs = [a.lstrip("@") for a in cfg.get("cd_managers", [])]

    items = search_triage_older_than(repo, days)
    for it in items:
        number = it["number"]
        # Has any comment from a Content Developer?
        comments = list_comments(repo, number)
        cd_commented = any(c.get("user",{}).get("login","").lower() in [u.lower() for u in cds] for c in comments)

        if not cd_commented:
            mention_cds = " ".join(f"@{u}" for u in cds) if cds else ""
            mention_mgrs = " ".join(f"@{u}" for u in mgrs) if mgrs else ""
            body = (
                f"â° **Follow-up:** No Content Developer response in {days} days.\n\n"
                f"{mention_cds} {mention_mgrs}\n\n"
                f"Please acknowledge or triage this issue."
            ).strip()
            comment(repo, number, body)

if __name__ == "__main__":
    main()
